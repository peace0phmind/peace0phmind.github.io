<!doctype html><html lang=zh-cn data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.105.0"><link rel="shortcut icon" type=image/x-icon href=/images/icons/favicon.ico><link rel=icon type=image/x-icon href=/images/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/images/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/images/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/images/icons/apple_touch_icon_next.png><meta itemprop=name content="在Pi4上编译ffmpeg支持硬件编解码以及测试和使用方法"><meta itemprop=description content><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://peace0phmind.github.io/images/avatar.png"><meta itemprop=keywords content="ai, python"><meta property="og:type" content="article"><meta property="og:title" content="在Pi4上编译ffmpeg支持硬件编解码以及测试和使用方法"><meta property="og:description" content><meta property="og:image" content="/images/avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://peace0phmind.github.io/posts/202011/build-ffmpeg-under-pi4/"><meta property="og:site_name" content="Mind's Home"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="peace0phmind"><meta property="article:published_time" content="2020-11-19 15:27:31 +0800 +0800"><meta property="article:modified_time" content="2020-11-19 15:27:31 +0800 +0800"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.1debdd839e63e3a60d7f3f743e3433d496d6166f4ca7410d8835cd7771845c86.css><style type=text/css>.post-footer{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"build-ffmpeg-under-pi4","permalink":"https://peace0phmind.github.io/posts/202011/build-ffmpeg-under-pi4/","title":"在Pi4上编译ffmpeg支持硬件编解码以及测试和使用方法","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>在Pi4上编译ffmpeg支持硬件编解码以及测试和使用方法 - Mind's Home</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Mind's Home</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Notebook</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#编译准备>编译准备</a></li><li><a href=#安装必要的工具和库>安装必要的工具和库</a></li><li><a href=#下载源代码并编译>下载源代码并编译</a></li><li><a href=#测试rtsp-h2641080p的cpu解码并每5s保存一张图片>测试rtsp h.264，1080p的cpu解码，并每5s保存一张图片</a></li><li><a href=#测试rtsp-h2641080p硬解并每5s保存一张图片>测试rtsp h.264，1080p硬解，并每5s保存一张图片</a></li><li><a href=#结论>结论</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=peace0phmind src=/images/img-lazy-loading.gif data-src=/images/avatar.png><p class=site-author-name itemprop=name>peace0phmind</p><div class=site-description itemprop=description></div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/posts/><span class=site-state-item-count>26</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>2</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>4</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/peace0phmind title="Github → https://github.com/peace0phmind" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2020-10-20T19:37:14+08:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=16323></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=45></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2022-11-04T23:29:09+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/peace0phmind rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://peace0phmind.github.io/posts/202011/build-ffmpeg-under-pi4/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/images/avatar.png"><meta itemprop=name content="peace0phmind"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="peace0phmind"><meta itemprop=description content></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="在Pi4上编译ffmpeg支持硬件编解码以及测试和使用方法"><meta itemprop=description content="由于某些原因，需要在raspberry pi 4上编译最新版本ffmpeg，下面是方法以及测试方案。 编译准备 sudo apt update sudo apt upgrade 安装必要的工具和库 sudo apt install build-essential"></span><header class=post-header><h1 class=post-title itemprop="name headline">在Pi4上编译ffmpeg支持硬件编解码以及测试和使用方法
<a href=https://github.com/peace0phmind/peace0phmind.github.io/tree/master/content/posts/202011/build-ffmpeg-under-pi4.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>发表于：</span>
<time title="发表于：2020-11-19 15:27:31 +0800 +0800" itemprop="dateCreated datePublished" datetime="2020-11-19 15:27:31 +0800 +0800">2020-11-19</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span><span>565</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>2分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/posts/202011/build-ffmpeg-under-pi4/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p>由于某些原因，需要在raspberry pi 4上编译最新版本ffmpeg，下面是方法以及测试方案。</p><h2 id=编译准备>编译准备</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt upgrade
</span></span></code></pre></div><h2 id=安装必要的工具和库>安装必要的工具和库</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo apt install build-essential yasm pkg-config libx264-dev
</span></span></code></pre></div><h2 id=下载源代码并编译>下载源代码并编译</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span># 下载并解压
</span></span><span style=display:flex><span>wget http://ffmpeg.org/releases/ffmpeg-snapshot-git.tar.bz2
</span></span><span style=display:flex><span>tar jxvf ffmpeg-snapshot-git.tar.bz2
</span></span><span style=display:flex><span>cd ffmpeg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 切换到明确的tag并创建分支
</span></span><span style=display:flex><span>git checkout tags/n4.3.1 -b b4.3.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./configure --enable-gpl --enable-libx264 --enable-mmal --enable-omx --enable-omx-rpi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>## pi4 2G上大约需要14分钟左右，请注意cpu散热
</span></span><span style=display:flex><span>make -j4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo make install
</span></span></code></pre></div><h2 id=测试rtsp-h2641080p的cpu解码并每5s保存一张图片>测试rtsp h.264，1080p的cpu解码，并每5s保存一张图片</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>ffmpeg -rtsp_transport tcp -nostdin -loglevel error -i rtsp://username:password@ip -filter:v fps=fps=1/5 test_%03d.jpg
</span></span></code></pre></div><p>通过
<a href=https://github.com/MilhouseVH/bcmstat title=bcmstat rel="noopener external nofollow noreferrer" target=_blank class=exturl>bcmstat
<i class="fa fa-external-link-alt"></i>
</a>软件观察，cpu消耗每路17%,内存消耗较少，约60MB。</p><h2 id=测试rtsp-h2641080p硬解并每5s保存一张图片>测试rtsp h.264，1080p硬解，并每5s保存一张图片</h2><p>首先需要配置GPU内存到300MB左右，默认76MB，配置路径为：Start->Preferences->Raspberry Pi Configuration->Performance->GPU Memory</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>ffmpeg -c:v h264_mmal -rtsp_transport tcp -nostdin -loglevel error -i rtsp://username:password@ip -filter:v fps=fps=1/5 test_%03d.jpg
</span></span></code></pre></div><p>通过
<a href=https://github.com/MilhouseVH/bcmstat title=bcmstat rel="noopener external nofollow noreferrer" target=_blank class=exturl>bcmstat
<i class="fa fa-external-link-alt"></i>
</a>软件观察，cpu消耗一路9%左右，内存消耗也需要60MB，另外需要GPU mem约94MB。</p><p><code>注</code>:使用GPU硬解码两路时，cpu上升到28%左右，内存和gpu内存也等比上升。</p><h2 id=结论>结论</h2><p>使用pi的h264硬件解码时，除GPU额外内存消耗较大外，节省的cpu使用率也很少。当然，目前仅进行了ffmpeg的测试，并未通过其他软件来证实是芯片自生问题还是ffmpeg硬件解码算法问题。建议大家使用ffmpeg解码时，仅进行一路硬解。</p><h2 id=参考>参考</h2><p><a href=https://trac.ffmpeg.org/wiki/CompilationGuide/Ubuntu title="Compile FFmpeg for Ubuntu, Debian, or Mint" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Compile FFmpeg for Ubuntu, Debian, or Mint
<i class="fa fa-external-link-alt"></i></a></p><p><a href=https://www.redhenlab.org/home/the-cognitive-core-research-topics-in-red-hen/the-barnyard/hardware-encoding-with-the-raspberry-pi title="Hardware Encoding with the Raspberry Pi" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Hardware Encoding with the Raspberry Pi
<i class="fa fa-external-link-alt"></i></a></p></div><footer class=post-footer><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/posts/202011/how-to-build-ubuntu-arm64-docker/ rel=next title="分析Ubuntu Arm64 Docker Build"><i class="fa fa-chevron-left"></i> 分析Ubuntu Arm64 Docker Build</a></div><div class="post-nav-prev post-nav-item"><a href=/posts/202011/init-pi4/ rel=prev title="Raspberry PI4环境初始化">Raspberry PI4环境初始化
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2022</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>peace0phmind</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://peace0phmind.github.io","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.0","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.c000895f35c4f549795bbb87a678888fa0246f9513d456814f0988441a9a4b7c.js defer></script><script type=text/javascript>window.MathJax={options:{ignoreHtmlClass:"markmap"},tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!1,packages:{"[+]":["noerrors"]}},loader:{load:["[tex]/noerrors"]}}</script>
<script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js integrity crossorigin=anonymous></script></body></html>